extends ../layout

block content
    .container
        nav(aria-label='breadcrumb')
            ol.breadcrumb.mt-5.pl-2.pr-2
                li.breadcrumb-item
                    a(href='/') Home
                li.breadcrumb-item.active
                    a(href='/board/vs/1' aria-current='page') vs 게시판
        .card.mt-3
            h5.card-header=post.title
            .card-body.border-bottom.mb-3!= post.content
            .card-body.mb-3.border-bottom
                .row.text-center
                    .col-2
                    if user
                        -const voter = post && post.Voter.map(l => l.id).includes(user.id);
                        if user && !voter
                            .col-4
                                .vs-left.card#left
                                    div(style="width: 200; height: 200px;")
                                        if !post.img_left
                                            img.card-img-top(src='/images/toright.png' width="200" height="200" alt='닥전')
                                        else
                                            img.card-img-top(src=post.img_left width="200" height="200" alt='닥전')
                                    .card-body.border-top
                                        p.card-title #{post.description_left}
                                        //a.btn.btn-primary(href='#') 닥전
                            .col-4
                                .vs-right.card#right
                                    div(style="width: 200; height: 200px;")
                                        if !post.img_right
                                            img.card-img-top(src='/images/toleft.png' width="200" height="200" alt='닥전')
                                        else
                                            img.card-img-top(src=post.img_right width="200" height="200" alt='닥후')
                                    .card-body.border-top
                                        p.card-title #{post.description_right}
                                        //a.btn.btn-primary(href='#') 닥후
                        else if user && voter
                            .col-4
                                .vs-left.card
                                    div(style="width: 200; height: 200px;")
                                        if !post.img_left
                                            img.card-img-top(src='/images/toright.png' width="200" height="200" alt='닥전')
                                        else
                                            img.card-img-top(src=post.img_left width="200" height="200" alt='닥전')
                                    .card-body.border-top
                                        p.card-title #{post.description_left}
                                    .card-body.border-top
                                        #left-progress-div.progress
                                            #left-progress.progress-bar.progress-bar-striped.bg-warning(role='progressbar' style='width: 0%;'
                                                aria-valuenow='25' aria-valuemin='0' aria-valuemax='100') #{leftPer} %

                            .col-4
                                .vs-right.card
                                    div(style="width: 200; height: 200px;")
                                        if !post.img_right
                                            img.card-img-top(src='/images/toleft.png' width="200" height="200" alt='닥전')
                                        else
                                            img.card-img-top(src=post.img_right width="200" height="200" alt='닥후')
                                    .card-body.border-top
                                        p.card-title #{post.description_right}
                                    .card-body.border-top
                                        #right-progress-div.progress
                                            #right-progress.progress-bar.progress-bar-striped.bg-warning(role='progressbar' style='width: 0%;'
                                                aria-valuenow='25' aria-valuemin='0' aria-valuemax='100') #{rightPer} %

            .text-center.mb-3.mt-3
                if user
                    -const liker = post && post.postLiker.map(l => l.id).includes(user.id);
                    if user && !liker
                        button.like.btn.btn-outline-warning.text-dark
                            img#nolike(style=' width:30px; height:30px;' src='/images/egg.png')
                            span#count(style='vertical-align: middle;') #{post.like} LIKE
                    else if user && liker
                        button.unlike.btn.btn-outline-warning.text-dark.btn-warning
                            img#nolike(style=' width:30px; height:30px;' src='/images/likedegg.png')
                            span#count(style='vertical-align: middle;') #{post.like} LIKE

        // 댓글쓰기
        .mt-3.border-bottom
            h5 댓글
            .mt-3
                form#comment-form.needs-validation(method='post' action='/post/' + post.board_type + '/' + post.id + '/comment' novalidate)
                    .row.mb-5
                        .col-10
                            textarea.form-control(name='content' aria-label='With textarea' rows='2' required)
                        .col-2
                            button#comment-form-button.btn.btn-warning.h-100.mr-2(type='submit') 댓글 달기
                        small.invalid-feedback.mb-5 내용을 입력하세요.

            each comment in comments
                .border-top.pt-1.pb-1
                    .row.mt-2
                        .col-3.col-md-2.col-lg-1=comment.user.nickname
                        .col-6.col-md-7.col-lg-8
                            .comment-show
                                .comment-text.mb-3=comment.content
                                    span.commentId(hidden)=comment.id
                                small.d-block
                                - let dateform = new Date(comment.createdAt)
                                - moment.locale('ko');
                                - let resultDate = moment(dateform).startOf('hour').fromNow();
                                    small=resultDate
                        .col-3.btn-group.btn-group-sm(role='group')
                            small.d-block
                                small.d-block
                                    if user
                                        -const liker = comment && comment.commentLiker.map(l => l.id).includes(user.id);
                                        if user && !liker
                                            form.d-inline(method='post' action=`${post.id}/like/comment/${comment.id}`)
                                                button.likeComment.btn.btn-outline-warning.text-dark
                                                    img#nolike(style=' width:20px; height:20px;  ' src='/images/egg.png')
                                                    span#count(style='vertical-align: middle;') #{comment.like} LIKE
                                        else if user && liker
                                            form.d-inline(method='post' action=`${post.id}/like/comment/${comment.id}/delete`)
                                                button.unlikeComment.btn.btn-outline-warning.text-dark.alert-warning
                                                    img#nolike(style=' width:20px; height:20px;' src='/images/likedegg.png')
                                                    span#count(style='vertical-align: middle;') #{comment.like} LIKE
                                    //button.btn.btn-warning(type='button') 좋아요
                                    if user
                                        form.d-inline(method='post' action=`${post.id}/comment/${comment.id}/delete`)
                                            button.btn.btn-outline-warning.text-dark.alert-warning(type='submit') 삭제
        br.mb-5
        br
        br






    include ../form-validation
    script(type='application/javascript').
        let unlikeTag = document.querySelector('.unlike');
        let likeTag = document.querySelector('.like');

        $(function () {
            let pathname = window.location.pathname;
            likeTag.addEventListener('click', function () {
                // let postId = document.querySelector('#post-id').value;
                let xhr = new XMLHttpRequest();
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        console.error(xhr.responseText);
                    }
                };
                xhr.open('POST', pathname + '/like');
                xhr.send();
            });
        });

        $(function () {
            let pathname = window.location.pathname;
            unlikeTag.addEventListener('click', function () {
                // let postId = document.querySelector('#post-id').value;
                let xhr = new XMLHttpRequest();
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        console.error(xhr.responseText);
                    }
                };
                xhr.open('DELETE', pathname + '/like');
                xhr.send();
            });
        });

        let left = document.querySelector('#left');
        let right = document.querySelector('#right');

        $(function () {
            let pathname = window.location.pathname;
            left.addEventListener('click', function () {
                let xhr = new XMLHttpRequest();
                let data = {'target': 'left'};
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        console.error(xhr.responseText);
                    }
                };
                xhr.open('POST', pathname + '/vote');
                xhr.setRequestHeader('Content-Type', 'application/json'); // 컨텐츠타입을 json으로
                xhr.send(JSON.stringify(data));
            });
            right.addEventListener('click', function () {
                let xhr = new XMLHttpRequest();
                let data = {'target': 'right'};
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        console.error(xhr.responseText);
                    }
                };
                xhr.open('POST', pathname + '/vote');
                xhr.setRequestHeader('Content-Type', 'application/json'); // 컨텐츠타입을 json으로
                xhr.send(JSON.stringify(data));
            });



        });
        window.addEventListener('load', function () {
            let left = document.getElementById('left-progress');
            let leftProgressGroup = document.getElementById('left-progress-div');
            leftProgressGroup.style.display = "block";
            setTimeout(function () {
                left.style.width = !{leftPer} + "%";
            }, 200);

            let right = document.getElementById('right-progress');
            let rightProgressGroup = document.getElementById('right-progress-div');
            rightProgressGroup.style.display = "block";
            setTimeout(function () {
                right.style.width = !{rightPer} + "%";
            }, 200);
        });